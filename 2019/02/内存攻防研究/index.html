














<!doctype html>
<html lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" , user-scalable="no"">
  <title>内存攻防研究Palm Civet</title>
  <link rel="shortcut icon" href>
  
    
    
      <link rel="stylesheet" href="/css/bootstrap.min.css">
    
      <link rel="stylesheet" href="/css/font-awesome.min.css">
    
      <link rel="stylesheet" href="/css/atom-one-dark.css">
    
      <link rel="stylesheet" href="/css/jquery.fancybox.css">
    
      <link rel="stylesheet" href="/css/nprogress.min.css">
    
      <link rel="stylesheet" href="/css/valine.css">
    
      <link rel="stylesheet" href="/css/life.css">
    
  

  

  <!-- jQuery first, then Tether, then Bootstrap JS. -->
  
  
  
    <script src="/js/jquery-2.2.4.min.js"></script>
  
    <script src="https://cdn1.lncld.net/static/js/3.1.0/av-min.js"></script>
  
    <script src="/js/jquery.pjax.js"></script>
  
    <script src="/js/nprogress.min.js"></script>
  
    <script src="/js/tether.min.js"></script>
  
    <script src="/js/bootstrap.min.js"></script>
  
    <script src="/js/highlight.min.js"></script>
  
    <script src="/js/highlightjs-line-numbers.min.js"></script>
  
    <script src="/js/jquery.fancybox.js"></script>
  
    <script src="/js/jquery.qrcode.min.js"></script>
  
    <script src="/js/Valine.min.js"></script>
  
  
</head>
<body>
<script>AV.init({appId:'',appKey:''});</script>
<script type="text/javascript">
      var config = {
            ClasS: 'Counter',
            el:'.views',
            elP: '.views-post'
      }
</script>
<div class="container">
    <div class="row blog-box-shadow">
        <!--博客主栏开始-->
        <div class="col-xl-9 col-lg-12 blog-main" id="pjax-box">
            <header class="blog-header">
                <a href="https://palmcivet.github.io" class="blog-header-mobile-title">Palm Civet</a>
                <a href="javascript:;" class="blog-header-navbar-btn"><i class="fa fa-bars"></i></a>
                <nav class="blog-header-navbar blog-header-fixed">
                    <ul class="blog-navbar-links">
                        
                          <li class="blog-nav-item"><a href="/" class="transition">首页</a></li>
                        
                          <li class="blog-nav-item"><a href="/about/" class="transition">关于</a></li>
                        
                          <li class="blog-nav-item"><a href="/links/" class="transition">链接</a></li>
                        
                        <div class="blog-navbar-right">
                            <form action>
                                <div class="input-group">
                                    <input type="text" class="blog-header-search" placeholder="search...">
                                    <buttn type="submit" class="blog-header-search-btn"><i class="fa fa-search"></i></buttn>
                                </div>
                            </form>
                        </div>
                    </ul>
                </nav>
            </header>
                
<header class="blog-post-page-title">
    <h4>内存攻防研究</h4>
    <time datetime="2019-02-21T14:16:21.662Z"><i class="fa fa-clock-o"></i>2019-02-21</time>
    
    
    
    
	
        <span><i class="fa fa-folder-o"></i>
    		
    	       <a href="/categories/Code-文章分类/" rel="categories" data-toggle="tooltip" data-placement="top" title="Linux">Code        //文章分类</a>
    		
        </span>
	
    
</header>
<div class="blog-main-post blog-post-page-box">
    <article class="blog-post-block blog-post-page-content">
        <section>
            
                <p>[toc]</p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="内存攻防"><a href="#内存攻防" class="headerlink" title="内存攻防"></a>内存攻防</h2><p>攻击者利用软件安全漏洞，构造 <strong>恶意输入</strong> 导致软件在处理数据时出现非预期的错误，将输入数据写入内存中的某些特定敏感位置，从而 <strong>劫持软件控制流</strong>，转而执行外部输入的指令代码，造成目标系统被获取远程控制或拒绝服务</p>
<h2 id="客户端攻击"><a href="#客户端攻击" class="headerlink" title="客户端攻击"></a>客户端攻击</h2><p>客户端渗透攻击（Client-side Exploit）是攻击者构造畸形数据发送给目标主机，客户端应用程序处理数据时发生内部错误，执行了内嵌于数据中的代码，从而导致被渗透</p>
<h2 id="攻防博弈"><a href="#攻防博弈" class="headerlink" title="攻防博弈"></a>攻防博弈</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">基础攻击     ----&gt;  GS cookie</span><br><span class="line">SEH 利用    ----&gt;   SafeSEH</span><br><span class="line">PPR         ---&gt;   SEHOP</span><br><span class="line">伪造 SEH    ---&gt;    ASLR</span><br><span class="line">堆喷射       ---&gt;   DEP</span><br><span class="line">ROP         ---&gt;   DEP+ASLR</span><br><span class="line">JIT Spray</span><br></pre></td></tr></table></figure>
<h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><h2 id="缓冲区溢出"><a href="#缓冲区溢出" class="headerlink" title="缓冲区溢出"></a>缓冲区溢出</h2><blockquote>
<p>Buffer Overflow</p>
</blockquote>
<p>缓冲区是一块可用于接收和存放数据的存储区域，每个进程都有一组缓冲区，在进程内存的 <code>.data</code>、<code>.bss</code> 节区分配内存可以使缓冲区保持连接</p>
<p>缓冲区溢出漏洞是程序由于缺乏对缓冲区的边界条件检查而引起的一种异常行为。通常是向缓冲区写入数据时内容超过边界，从而覆盖相邻的内存区域</p>
<p>根据缓冲区溢出内存位置的不同，又可分为 <strong>栈溢出</strong> 和 <strong>堆溢出</strong></p>
<h3 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h3><blockquote>
<p>Stack Overflow</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> arvc,<span class="keyword">char</span> * argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> a[<span class="number">7</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(a,argv[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>攻击方式：</p>
<ol>
<li>覆盖缓冲区附近的程序变量</li>
<li>覆盖栈中保存的函数返回地址</li>
<li>覆盖某个函数指针或异常处理结构</li>
</ol>
<h4 id="漏洞攻击组件"><a href="#漏洞攻击组件" class="headerlink" title="漏洞攻击组件"></a>漏洞攻击组件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text | .data | .bss | 堆 |--&gt; 未使用 &lt;--|   栈帧               | 环境/参数</span><br><span class="line">低位 &lt;--------------------- 缓冲区 ------ | ESP | EBP | EIP | &lt;------- 高位</span><br><span class="line">                    | NOP sled |    shellcode     | 重复地址 |</span><br></pre></td></tr></table></figure>
<ol>
<li>NOP 雪橇<blockquote>
<p>NOP，No Operation，空指令</p>
<ul>
<li>Intel x86 架构操作码是 <code>0x90</code></li>
<li>NOP 雪橇（NOP sled）是一串放在漏洞攻击缓冲区前的空指令</li>
</ul>
</blockquote>
</li>
<li>shellcode：攻击载荷</li>
<li>重复地址<br> 填充缓冲区直至覆盖 EIP，使其指向 NOP 雪橇区中部或 shellcode 开始处</li>
</ol>
<h4 id="小缓冲区漏洞攻击"><a href="#小缓冲区漏洞攻击" class="headerlink" title="小缓冲区漏洞攻击"></a>小缓冲区漏洞攻击</h4><p>将 shellcode 放在 <strong>环境变量节</strong><br><em>Linux</em> ELF 文件在映射到内存中时会将最后相对地址设为 <code>0xBFFFFFFF</code>，环境变量和参数存储在该区域<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    栈 | 环境变量/参数 | shellcode | 程序名称 | 4 个空字节</span><br><span class="line">    |                  |           |                |</span><br><span class="line">0x11111111           code     0xbffffffa      0xbfffffff</span><br></pre></td></tr></table></figure></p>
<h4 id="覆盖异常处理结构"><a href="#覆盖异常处理结构" class="headerlink" title="覆盖异常处理结构"></a>覆盖异常处理结构</h4><p>Windows 提供 SEH（Structured Exception Handling，结构化异常处理），可利用程序自定义的异常处理函数或操作系统默认的函数处理异常</p>
<p>异常处理结构以链表形式存储在栈中，头指针存放在 <em>TIB</em> 的第一个成员中，<em>x86</em> 对应存储在寄存器 <em>FS</em>，结构体有两个 DWORD 类型的变量：</p>
<ol>
<li>指向下一个异常处理结构体的指针</li>
<li>异常处理函数 SEH 的地址</li>
</ol>
<p>异常处理结构更接近栈底，利用更加方便，可绕过栈保护机制</p>
<h3 id="堆溢出"><a href="#堆溢出" class="headerlink" title="堆溢出"></a>堆溢出</h3><blockquote>
<p>Heap Overflow</p>
</blockquote>
<p>堆是程序运行时动态分配的内存，堆操作有分配、释放、合并三种，位置不固定，大小自由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Size | Previous Size | SmallTag Index | Flags | Unused Bytes | Segment Index</span><br><span class="line">   Previous Block    | Next Block</span><br><span class="line">                    Data</span><br></pre></td></tr></table></figure>
<p>Previous Block 和 Next Block 分别指向双向链表中此块的前后空闲堆块的数据部分</p>
<p>arbitrary DWORD reset 攻击</p>
<h2 id="堆喷射"><a href="#堆喷射" class="headerlink" title="堆喷射"></a>堆喷射</h2><blockquote>
<p>Heap Spraying</p>
</blockquote>
<p>常见于浏览器<br>将空指令滑行区与 Shellcode 组合，重复填充到堆中，直到填满一大块内存空间</p>
<h2 id="格式化字符串漏洞"><a href="#格式化字符串漏洞" class="headerlink" title="格式化字符串漏洞"></a>格式化字符串漏洞</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    返回地址 | 格式化字符串地址 | 变量</span><br><span class="line">低地址 &lt;----- 函数内部指针 &lt;---- 高地址</span><br></pre></td></tr></table></figure>
<p>函数运行时遇到 <code>%</code>，就从栈顶抓取输入值<br>字符 <code>\</code> 会由编译器处理并用于将其后的字符转义，但遇到 <code>\x</code>，则会认为后面是一个数字</p>
<h3 id="读取内存"><a href="#读取内存" class="headerlink" title="读取内存"></a>读取内存</h3><ol>
<li><code>%x</code> 映射栈<br> 格式化字符串存储于栈上，不断增加 <code>%x</code> 的数目找到格式化字符串</li>
<li><code>%s</code> 读取任意字符串</li>
<li>用直接参数访问简化内存读取</li>
</ol>
<h3 id="写入内存"><a href="#写入内存" class="headerlink" title="写入内存"></a>写入内存</h3><ul>
<li>HOB 高位字节</li>
<li>LOB 低位字节</li>
</ul>
<p>魔术公式，按照顺序构造字符串：<br>| HOB &lt; LOB        | HOB &gt; LOB        | 备注             | 示例                     |<br>| —————- | —————- | —————- | ———————— |<br>| <code>[addr+2][addr]</code> | <code>[addr][addr+2]</code> |                  |                          |<br>| <code>%.[HOB-8]x</code>     | <code>%.[LOB-8]x</code>     | 数值用十进制表示 | %.49143x = oxbfff-8      |<br>| <code>%[offset]$hn</code>   | <code>%[offset+1]$hn</code> |                  | %4\$hn                   |<br>| <code>%.[LOB-HOB]</code>    | <code>%.[HOB-LOB]</code>    | 数值用十进制表示 | %.16209x = 0xff50-0xbfff |<br>| <code>%[offset+1]$hn</code> | <code>[offset]%hn</code>    |                  | %5\$hn                   |</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="维持调用权限"><a href="#维持调用权限" class="headerlink" title="维持调用权限"></a>维持调用权限</h2><p>某些发行版打开 <em>bash</em> 时会降低权限，则用 <code>execl()</code> 包装 <code>system()</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">溢出 | &amp;printf | &amp;execl | &amp;&quot;%3h\$n&quot; | &amp;&quot;./code&quot; | &amp;&quot;./code&quot;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// code</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    setuid(<span class="number">0</span>);</span><br><span class="line">    setgid(<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">"/bin/bash"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// packaging</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    execl(<span class="string">"./code"</span>, <span class="string">"./code"</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>攻击字符串最后一位时 <code>NULL</code>，因此可直接传入以代替 <code>printf()</code></p>
<h1 id="攻防研究"><a href="#攻防研究" class="headerlink" title="攻防研究"></a>攻防研究</h1><h2 id="Libsafe-库"><a href="#Libsafe-库" class="headerlink" title="Libsafe 库"></a>Libsafe 库</h2><p>是一个 <strong>动态库</strong>，重写危险的 Libc 函数，避免了大多数基于栈的攻击</p>
<h2 id="StackShield"><a href="#StackShield" class="headerlink" title="StackShield"></a>StackShield</h2><p><strong>编译器</strong>，<em>GCC</em> 的替代品，可以在编译时捕获不安全的操作</p>
<h2 id="SSP"><a href="#SSP" class="headerlink" title="SSP"></a>SSP</h2><blockquote>
<p>Stack Smashing Protection，栈破坏保护，以前称为 ProPolice</p>
</blockquote>
<ul>
<li>通过将栈变量重新排布，改进了 StackGuard 基于检测仪的保护机制，还提供了函数开场白和收场白</li>
<li>GCC 从 4.1 开始，加入 SSP，编译时加 <code>-fno-stack-protector</code> 选项可禁用栈保护</li>
</ul>
<h2 id="基于栈的缓冲区溢出检测"><a href="#基于栈的缓冲区溢出检测" class="headerlink" title="基于栈的缓冲区溢出检测"></a>基于栈的缓冲区溢出检测</h2><ol>
<li><code>/GS</code> 编译选项：是微软的堆栈检测仪（Stack Canary）概念的具体体现<ul>
<li>从 Visual Studio 2003 开始引入，XP SP2 开始全面支持</li>
<li>将一个随机生成的 cookie 放在 <em>EBP</em> 和 <em>RETN</em> 上方，函数返回时校验该值，并有新的函数开场白</li>
</ul>
</li>
<li><em>StackGuard</em>： 在栈缓冲区与栈帧状态值之间放置检测仪</li>
</ol>
<h3 id="覆盖调用函数指针"><a href="#覆盖调用函数指针" class="headerlink" title="覆盖调用函数指针"></a>覆盖调用函数指针</h3><p>利用过早被删除的 C++ 类的实例化对象，存在悬空指针的 Bug</p>
<h3 id="替换-cookie"><a href="#替换-cookie" class="headerlink" title="替换 cookie"></a>替换 cookie</h3><p>cookie 存放在内存的 <code>.data</code> 段，由于需要在运行时计算并写入，因此可写。如果拥有写人以内存的权限即可重写该值</p>
<h3 id="覆盖-SEH-记录"><a href="#覆盖-SEH-记录" class="headerlink" title="覆盖 SEH 记录"></a>覆盖 SEH 记录</h3><p><code>/GS</code> 保护机制没有保护保存在栈上的 SEH 结构，如果能够写入足够的数据覆盖 SEH 记录，并在函数收场白和 cookie 检查之前触发异常，就可以控制程序流程</p>
<h2 id="SafeSEH"><a href="#SafeSEH" class="headerlink" title="SafeSEH"></a>SafeSEH</h2><blockquote>
<p>Safe Exception Handling，安全结构化异常处理</p>
</blockquote>
<ul>
<li>这一机制是防止覆盖和使用存储栈上的 <em>SEH</em> 结构</li>
<li>具体实现在微软的 <code>/SafeSEH</code> 编译选项。</li>
<li>当触发异常时，操作系统会在栈上放置<em>_except_handler</em> 函数来处理，采用句柄验证技术<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXCEPTION_DISPOSITION __cdecl_except_handler(</span><br><span class="line">    struct _EXCEPTION_RECORD *_ExceptionRecord,</span><br><span class="line">    <span class="keyword">void</span> * _EstablisherFrame,</span><br><span class="line">    struct _CONTENT *_ContentRecord,</span><br><span class="line">    <span class="keyword">void</span> * _DispatcherContext</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">栈 | RET | _ExceptionRecord | _EstablisherFrame | _ContentRecord | _DispatcherContext | </span><br><span class="line">     ESP                      ESP+8</span><br></pre></td></tr></table></figure>
<h3 id="利用未启用的模块"><a href="#利用未启用的模块" class="headerlink" title="利用未启用的模块"></a>利用未启用的模块</h3><p>利用进程中未启用的 SEH 模块，将修改后的 SEH 例程指针指向模块中的 POP/POP/RTEN（P/P/R）指令代码块，跳回到栈上执行 shellcode</p>
<h2 id="SEHOP"><a href="#SEHOP" class="headerlink" title="SEHOP"></a>SEHOP</h2><blockquote>
<p>SEH Overwrite Protection，SEH 覆盖保护</p>
</blockquote>
<p>Windows Server 2008 中增加的机制，由 <em>RtlDispatchException</em> 例程实现，会 <strong>遍历</strong> 异常处理程序链表，并确认能够到达 <em>ntdll.dll</em> 中的 <em>FinalExceptionHandler</em> 函数</p>
<h3 id="进一步伪造-SEH-链表"><a href="#进一步伪造-SEH-链表" class="headerlink" title="进一步伪造 SEH 链表"></a>进一步伪造 SEH 链表</h3><p>重新构造一个以实际系统默认异常处理程序（<em>ntdll!FinalExceptionHandler</em>）结尾的 SEH 链表<br>这种攻击只在有限条件下才能奏效：</p>
<ol>
<li>具有 <strong>本地</strong> 系统访问权限</li>
<li>存在可以使用 <strong>空字节</strong> 的 <code>memcpy</code> 类型的漏洞</li>
<li>被控制的栈内存地址的第3个字节在 <code>0x80</code> 和 <code>0xFB</code> 之间</li>
<li>能找到一个没有受到 <em>SafeSE</em> 保护的模块，且其包含以下指令序列：<ol>
<li>XOR</li>
<li>POP</li>
<li>POP</li>
<li>RETN</li>
</ol>
</li>
</ol>
<h2 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h2><blockquote>
<p>Address Space Layout Randomization，地址空间布局随机化</p>
</blockquote>
<p>将下面内存对象随机化：</p>
<ul>
<li>可执行映像</li>
<li>库映像</li>
<li><code>Brk()</code> 管理的堆</li>
<li><code>Mmap()</code> 管理的堆</li>
<li>用户栈</li>
<li>内核栈</li>
</ul>
<p>Windows 在 Vista 及后续操作系统正式引入 ASLR，不同平台熵值不同：</p>
<ul>
<li>Win7 的 <strong>PEB/TEB</strong> 和 <strong>堆</strong> 较低</li>
<li>Win8 引入了强制高熵值 ASLR</li>
</ul>
<p>将程序编译成 PIE（位置无关可执行文件），是一种内存攻击 <strong>缓解</strong> 技术，增加了漏洞利用的难度，并不能解决漏洞，仍具有局限性：</p>
<ul>
<li>不能报告或追踪漏洞</li>
<li>不能对编译时未开启 ASLR 的二进制文件提供保护</li>
<li>不能避免被绕过</li>
</ul>
<h3 id="利用泄露的内存地址信息"><a href="#利用泄露的内存地址信息" class="headerlink" title="利用泄露的内存地址信息"></a>利用泄露的内存地址信息</h3><p>若已加载模块某个已知对象地址被获知，便可以计算出重定位的加载基址，动态生成 ROP 链</p>
<h3 id="返回到未链接-ASLR-的模块"><a href="#返回到未链接-ASLR-的模块" class="headerlink" title="返回到未链接 ASLR 的模块"></a>返回到未链接 ASLR 的模块</h3><p>使用不受 ASLR 保护的代码</p>
<h3 id="堆喷射-1"><a href="#堆喷射-1" class="headerlink" title="堆喷射"></a>堆喷射</h3><p>使用脚本语言在堆上布置大量含有 shellcode 的代码块，增加某一内存地址位于指令块的几率</p>
<h3 id="侧信道攻击"><a href="#侧信道攻击" class="headerlink" title="侧信道攻击"></a>侧信道攻击</h3><h3 id="禁用-ASLR"><a href="#禁用-ASLR" class="headerlink" title="禁用 ASLR"></a>禁用 ASLR</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Debian / Ubuntu</span><br><span class="line"><span class="built_in">echo</span> <span class="number">0</span> &gt; /proc/sys/kernel/randomize_va_space</span><br><span class="line"></span><br><span class="line"># Red Hat</span><br><span class="line"><span class="built_in">echo</span> <span class="number">1</span> &gt; /proc/sys/kernel/exec-shield</span><br><span class="line"><span class="built_in">echo</span> <span class="number">1</span> &gt; /proc/sys/kernel/exec-shield-randomize</span><br></pre></td></tr></table></figure>
<h2 id="DEP"><a href="#DEP" class="headerlink" title="DEP"></a>DEP</h2><blockquote>
<p>Data Execution Protection，数据执行保护</p>
</blockquote>
<p>将程序数据段所在的内存页的属性设置为 <strong>不可执行</strong></p>
<ol>
<li>AMD：No-Excute Page-Protection（NX）</li>
<li>Intel：Execute Disabled Bit（XD）</li>
</ol>
<ul>
<li>软件 DEP（SafeSEHR）：XP SP2 提出，Vista 开始全面支持</li>
<li>Page-eXec（Pax）：通过改变内存分页的方式对内存的堆和栈区域提供控制<blockquote>
<p>通常 <em>页表项</em>（PTE）用于跟踪内存页和缓存机制（称为 <em>数据和指令旁会路转换缓冲器</em>，TLB），TLB 存储着最近访问的内存页的信息，当访问内存时会先检查这里，若缓存缺失则使用 PTE 来查找并访问内存页，Pax 补丁为 TLB 实现了一组状态表，并指示内存页权限</p>
</blockquote>
</li>
<li>不可执行栈<ul>
<li>基于 GCC，使用 ELF 标记 GNU_STACK</li>
<li>可用 <code>-z execstack</code> 禁用</li>
</ul>
</li>
</ul>
<h3 id="Return-to-libc"><a href="#Return-to-libc" class="headerlink" title="Return to libc"></a>Return to libc</h3><p>使用受控制的 <em>EIP</em> 将执行控制权返回到现有的 <em>glibc</em> 库的函数而不是 shellcode<br>串联已经加载的系统库函数中以 RETN 结尾的代码块（gadget）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">缓冲区 | system()地址 | 填充物 |&quot;bin/bash&quot;地址 |</span><br><span class="line">        |              |</span><br><span class="line">--&lt;---- 当前 EIP &lt;---- 下一个 EIP &lt;-----------</span><br></pre></td></tr></table></figure>
<ol>
<li>将缓冲区溢出，用 <em>glibc</em> 的 <code>system()</code> 地址准确填写 <em>EIP</em>，<code>main()</code> 函数返回时将执行 <code>system()</code></li>
<li><code>system()</code> 参数在 <em>EIP</em> 右侧</li>
</ol>
<h3 id="VirtualProtect"><a href="#VirtualProtect" class="headerlink" title="VirtualProtect"></a>VirtualProtect</h3><p>某个进程要执行在堆或栈中的代码，可以使用 <em>MSVCR71.dll</em> <code>VirtualAlloc</code> 或 <code>VirtualProtect</code> 来分配内存并标记为可执行</p>
<h3 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h3><blockquote>
<p>Return-Oriented Programming，返回导向编程</p>
</blockquote>
<ul>
<li>Return to libc 技术的继任者，利用进程中系统库函数以外安全防护较低的 <strong>第三方模块</strong> 中的 gadget</li>
<li>由运行时载入的多个指令片段（gadget）组成，用 <strong>可执行的指令</strong> 以代替原本写入的不可执行的代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mono rop -m &lt;msvcr71.dll&gt; -cp nonull</span><br></pre></td></tr></table></figure>
<p>使用 <em>Mona PyCommand</em> 插件可找出针对给定模块的推荐指令片段：</p>
<ol>
<li><code>rop_chains.txt</code>：绕过 DEP 的半成品</li>
<li><code>rop.txt</code>：包含漏洞开发攻击程序</li>
<li><code>stackivot.txt</code>：包含堆栈交换指令</li>
</ol>
<h2 id="DEP-ASLR"><a href="#DEP-ASLR" class="headerlink" title="DEP+ASLR"></a>DEP+ASLR</h2><p>Windows 7 开始启用</p>
<h3 id="JIT-Spray"><a href="#JIT-Spray" class="headerlink" title="JIT Spray"></a>JIT Spray</h3><p>利用支持 JIT（Just in Time）编译的脚本解释器，在脚本中部署大量 XOR 指令，即时编译之后将在内存中放置大量可执行机器码<br>大量 XOR 操作的机器码具有可预见性，可以劫持并且绕过 ASLR</p>
<h2 id="EMET"><a href="#EMET" class="headerlink" title="EMET"></a>EMET</h2><blockquote>
<p>Enhanced Mitigation Experience Toolkit，增强缓解体验工具包，微软提供的用于缓解攻击危害</p>
</blockquote>
<h2 id="堆保护"><a href="#堆保护" class="headerlink" title="堆保护"></a>堆保护</h2><ul>
<li>Safe unlinking：安全移除，移除前检查向前向后的指针是否指向相同的块</li>
<li>Heap metadata cookie：堆元数据 cookie，块首部存储一字节的 cookie，移除前检查该值</li>
</ul>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ol>
<li>《灰帽黑客 正义黑客的道德规范、渗透测试、攻击方法和漏洞分析技术》（第4版）</li>
<li>《Metasploit 渗透测试魔鬼训练营》</li>
</ol>

            
        </section>
        <footer class="blog-post-page-tags">
        
			
		
        </footer>
    </article>
    <article class="blog-post-page-readmore">
    	
    	
		
			<a href="/2019/03/hello-world/" class="blog-post-page-readmore-prev" data-toggle="tooltip" data-placement="top" title="Hello World">上一篇</a>
		

		
		

        <div style="clear: both;"></div>
    </article>

    <article class="blog-post-block blog-post-page-content">
            <div class="row">
            
                <div class="col-md-4 col-sm-4 post-page-more-btn">
                    <span class="post-comments-btn btn btn-info btn-block" data-toggle="tooltip" data-placement="top" title="本站采用Disqus评论组件，若您没有科学上网可能会无法查看并评论">加载评论</span>
                </div>
            
                <div class="col-md-4 col-sm-4 post-page-more-btn">
                    <span data-toggle="modal" data-target="#post-donate-content">
                        <span id="post-donate-btn" class="btn btn-danger btn-block" data-toggle="tooltip" data-placement="top" title="如果您觉得本文还不错或者对您有帮助，可以考虑打赏一下作者哦">打赏本文</span>
                    </span>
                </div>
                <div class="col-md-4 col-sm-4 post-page-more-btn">
                    <span data-toggle="modal" data-target="#post-qrcode-content">
                        <span><span id="post-qrcode-btn" class="btn btn-success btn-block" data-toggle="tooltip" data-placement="top" title="微信扫描二维码手机端查看本文及分享本文">二维码</span></span>
                    </span>
                </div>
            </div>
        <div class="post-more-function-br"></div>

        <div class="modal fade" id="post-donate-content" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">打赏本文</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row post-donate-content">
                            <div class="col-md-4">
                                <p>支付宝</p>
                                <img class="post-donate-content-img no-lightbox" src="http://dl.weic96.cn/logo.png">
                            </div>
                            <div class="col-md-4">
                                <p>微信</p>
                                <img class="post-donate-content-img no-lightbox" src="http://dl.weic96.cn/logo.png">
                            </div>
                            <div class="col-md-4">
                                <p>财付通</p>
                                <img class="post-donate-content-img no-lightbox" src="http://dl.weic96.cn/logo.png">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="post-qrcode-content" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">文章二维码</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row post-qrcode-content">
                            <span class="post-qrcode-content-canvas"></span>
                            <img class="post-qrcode-content-img no-lightbox" src>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            // post QRcode
            // 中文转码
            function toUtf8(str) {
                var out, i, len, c;
                out = "";
                len = str.length;
                for (i = 0; i < len; i++) {
                    c = str.charCodeAt(i);
                    if ((c >= 0x0001) && (c <= 0x007F)) {
                        out += str.charAt(i);
                    } else if (c > 0x07FF) {
                        out += String.fromCharCode(0xE0 | ((c >> 12) & 0x0F));
                        out += String.fromCharCode(0x80 | ((c >> 6) & 0x3F));
                        out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F));
                    } else {
                        out += String.fromCharCode(0xC0 | ((c >> 6) & 0x1F));
                        out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F));
                    }
                }
                return out;
            }
            // 生成
            var qrcode= $('.post-qrcode-content-canvas').qrcode({width: 150,height: 150,text: toUtf8("https://palmcivet.github.io/2019/02/内存攻防研究/")}).hide();
            var canvas=qrcode.find('canvas').get(0);
            $('.post-qrcode-content-img').attr('src',canvas.toDataURL('image/jpg'));
        </script>

        
    </article>
    
</div>

                
            <footer class="blog-footer">
                <p class="blog-footer-left">Copyright ©  2019 <a href="https://palmcivet.github.io">Palm Civet</a></p>
                <p class="blog-footer-right">Powered by <a href="https://hexo.io" target="_blank">Hexo</a>,Theme <a href="https://note.isweic.com/themes-life/" target="_blank">Life</a></p>
            </footer>
        </div><!--博客主栏结束-->
        <!--博客侧边栏开始-->
        <div class="col-xl-3 blog-sidebar">
            <div class="blog-sidebar-title">
                <a href>Palm Civet</a>
            </div>
            <div class="blog-sidebar-logo">
                <img src="http://dl.weic96.cn/logo.png">
            </div>
            <div class="blog-sidebar-count blog-sidebar-padding">
                <div class="blog-sidebar-count-left">
                    <p class="blog-sidebar-count-p">2</p>
                    <span class="blog-sidebar-count-span">文章</span>
                </div>
                <div class="blog-sidebar-count-right">
                    <p class="blog-sidebar-count-p">0</p>
                    <span class="blog-sidebar-count-span">标签</span>
                </div>
                <div style="clear: both;"></div>
            </div>
            <div class="blog-sidebar-icon blog-sidebar-padding">
                <ul>
                    <li><a href="https://github.com/Palmcivet/" class="icon-github" target="_blank" data-toggle="tooltip" data-placement="top" title="Github"><i class="fa fa-github"></i></a></li>
                    <li><a href class="icon-weibo" target="_blank" data-toggle="tooltip" data-placement="top" title="新浪微博"><i class="fa fa-weibo"></i></a></li>
                    <li><a href class="icon-twitter" target="_blank" data-toggle="tooltip" data-placement="top" title="Twitter"><i class="fa fa-twitter"></i></a></li>
                    <!--<li><a href="" class="icon-facebook" target="_blank" data-toggle="tooltip" data-placement="top" title="FaceBook"><i class="fa fa-facebook"></i></a></li>-->
                    <li><a href="mailto:Kongfupanda@126.com" class="icon-email" data-toggle="tooltip" data-placement="top" title="E-Mail"><i class="fa fa-envelope"></i></a></li>
                    <li><a href class="icon-rss" data-toggle="tooltip" target="_blank" data-placement="top" title="RSS"><i class="fa fa-rss"></i></a></li>
                </ul>
            </div>
            <div class="blog-sidebar-categories">
                <h4 class="blog-sidebar-h4"><i class="fa fa-folder-open"></i>&nbsp;文章分类</h4>
                <ul class="list-group blog-sidebar-padding">
                  
                    
                      <li class="list-group-item justify-content-between">
                          <a href="/categories/Code-文章分类/">Code        //文章分类</a>
                          <span class="badge badge-default badge-pill">1</span>
                      </li>
                    
                  
                </ul>
            </div>
            <div class="blog-sidebar-tags">
                <h4 class="blog-sidebar-h4"><i class="fa fa-tag"></i>&nbsp;标签云</h4>
                <ul class="blog-sidebar-tags-ul blog-sidebar-padding">
                  
                </ul>
            </div>
            <script>
              // 博客侧栏标签云随机色
              var tag_cloud = $('.tag-could');
              tag_cloud.each(function () {
                  var Cnum = 9;
                  var Crand = parseInt(Math.random() * Cnum);
                  $(this).addClass("tag-could" + Crand);
              })
            </script>
            <!--返回顶部按钮-->
            <div class="retop">
                <i class="fa fa-angle-up"></i>
            </div>
        </div><!--博客侧边栏结束-->
    </div>
</div>
<script src="/js/LeanStatistics.min.js"></script>
<script src="/js/Life.js"></script>
<script type="text/javascript">
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
    otherF();
    LeanStatistics();
    $(document).pjax('a', '#pjax-box', {fragment:'#pjax-box', timeout:8000}).on('pjax:complete', function() {
      $('pre code').each(function(i, block){
        hljs.highlightBlock(block);
      })
      $('code.hljs').each(function(i, block) {
        hljs.lineNumbersBlock(block);
      });
      LeanStatistics();
    }).on('pjax:start', function() { NProgress.start(); }).on('pjax:end',   function() {
      NProgress.done();
      otherF();
    });
</script>
</body>
</html>
